<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>蓝牙开发之 IOS ANCS | nixgnauhcuy</title><meta name="keywords" content="BLE,蓝牙,IOS,ANCS"><meta name="author" content="nixgnauhcuy"><meta name="copyright" content="nixgnauhcuy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="蓝牙开发之 IOS ANCS"><meta name="application-name" content="蓝牙开发之 IOS ANCS"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="蓝牙开发之 IOS ANCS"><meta property="og:url" content="https://www.nixgnauhcuy.cn/f0b6078aa8de/index.html"><meta property="og:site_name" content="nixgnauhcuy"><meta property="og:description" content="蓝牙开发 ANCS 相关总结。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/cover.png"><meta property="article:author" content="nixgnauhcuy"><meta property="article:tag" content="[&quot;blog&quot;,&quot;博客&quot;,&quot;技术&quot;,&quot;个人&quot;,&quot;学习&quot;,&quot;教程&quot;]"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/cover.png"><meta name="description" content="蓝牙开发 ANCS 相关总结。"><link rel="shortcut icon" href="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/other/favicon.png"><link rel="canonical" href="https://www.nixgnauhcuy.cn/f0b6078aa8de/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><meta name="google-site-verification" content="T9L_T3an8pckM0Sc0wa17RoeF1zsROoZJdv4B9ltUJM"/><meta name="baidu-site-verification" content="codeva-U5171cz6ED"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7e1d8d6cf9206f44c07c598f2d8377c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-2VWCFFF041"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-2VWCFFF041');
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/other/people.png"},
  postHeadAiDescription: undefined,
  diytitle: undefined,
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":90,"position":"top","messagePrev":"注意：自上次更新以来已有","messageNext":"天，文章的内容可能已过时，如果发现错误，请留言或发送邮件告知我。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: nixgnauhcuy","link":"链接: ","source":"来源: nixgnauhcuy","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'nixgnauhcuy',
  title: '蓝牙开发之 IOS ANCS',
  postAI: '',
  pageFillDescription: '什么是 ANCS, ANCS 介绍(Introduction), ANCS 字节序和字节码(Endianness and String Encoding), 依赖性(Dependencies), 术语(Terminology), ANCS 理解, ANCS 特征(Characteristic), 通知源(Notification Source), iOS 通知的生命周期, 控制点(Control Point)和数据源(Data Source), 获取通知属性, 获取应用程序属性, 执行通知操作, 通知动作, 其他, 会话(Session), 属性获取和缓存(Attribute Fetching and Caching), 错误代码(Error Codes), 示例, 结语更新蓝牙开发之有兴趣的可以点击链接进入更新接收推送效果上图演示了接收微信通知和通知的展示短信来电等我就不一一展示了什么是介绍全称苹果通知中心服务是提供给设备的一种获取设备通知的方法围绕三个原则进行设计简单高效和可扩展性以下引用自规范字节序和字节码除非另有规定否则通过传输的所有数值都应是小端格式除非另有规定否则通过传输的所有字符串值都应是编码的字符所组成的依赖性除了标准的通用属性配置文件子程序集外没有任何依赖性作为客户端的设备在使用时可以自由访问和使用设备提供的其他服务术语苹果通知中心服务应称为服务的发布者也就是我们的设备应被称为通知提供者服务的任何客户端也就是我们的蓝牙设备应被称为通知消费者在通知中心显示在设备上的通知应称为通知特性作为异步消息发送的通知应称为通知理解上面的对于什么是基本上都是其规范中所提及的不过不能在水文水下去了在水下去怕读者打我我们来谈谈对它的理解首先最重要的是它的和它告诉了我们它是一个通知服务它是基于封装的服务和我们的等服务都是一个档次的只不过它与和设备间制定了自己的一套协议我们要使用它就必须遵守它们之间的规则来办事那为什么我们用等蓝牙工具没办法看到相关的呢这就和的机制有关了对安全的考虑比安卓要严格的多是沙盒机制限制了每个应用不得翻越自己的围墙去访问别的存储空间的内容即使能访问也需要授权才可以所以接触的工程师告诉我他们没办法通过蓝牙去获取其他应用的通知所以提供了这样一个通知服务但是它是私有的并不会主动的广播所以我们用蓝牙工具是看不到这个服务的并且如果你也是蓝牙的开发者并且你也在折腾那么要清楚工程师并不需要在他们的代码中处理相关的代码我们在蓝牙中做好对的支持和响应剩下的就是我们蓝牙设备与设备的事了开发的工程师们如果觉得我理解不到位请轻点喷我并麻烦指正我的错误感激不尽主服务为服务下的三个特征通知源控制点数据源上述特征都需要授权才能访问并且通知源特性是必须要有的而其他两个控制点和数据源是可选的中存在的特征可能比上面列出的三个更多也就是说可以忽略任何它不识别的特性一个上只能存在一个的实例由于的特性不能保证始终存在因此应寻找并订阅服务的特性以便随时监控可能的发布和未发布的消息这里再扩展一下个人见解我们实际操作蓝牙服务时都是操作其句柄这与文件系统类似打个比方的主服务我们看作文件系统的磁盘的三个特征我们把它看作文件系统的文件例如三个文件那么的属性我们把它看作对文件操作时的读和写的属性是不是极其地相似我们磁盘后再文件用获得的句柄对这个文件就有了可读可写的属性就可以对文本中写入内容和读出内容这点是不是和蓝牙服务这一块极其相似当然这只是我个人的观点方便各位理解不一定对如果有误麻烦指正不胜感激特征通知源这个特征值是用于通知我们的蓝牙设备这一消费者下面则是得到通知的场景上有新的通知上修改了通知上删除了通知一旦监控了通知源特征那么通知就可以立即发送因此我们在监控这个特征之前应该处于可以正确接收和处理这些消息的状态通过通知源特征传递的通知包含以下信息此字段通知设备是否添加修改或删除了给定的通知此字段的枚举值在中定义通知已添加通知已修改通知已删除一个位掩码其设置位通过通知将其特殊性通知给例如如果将通知视为重要则可能希望显示一个更积极的用户界面以确保正确警告用户此字段的枚举位在中定义通知的优先级较低通知具有较高的优先级该通知已存在通知具有可以采取的积极行动通知具有可以采取的负面行动一个数值提供对通知进行分类的类别将尽最大努力为每个通知提供准确的类别此字段的枚举值在值中定义通知属于其他类别通知属于来电类别通知属于未接电话类别通知属于语音邮件类别通知属于社交类别通知属于时间表类别通知属于电子邮件类别通知属于新闻类别通知属于健康和健身类别通知属于商务和金融类别通知属于位置类别通知属于娱乐类别给定类别中当前活动的通知数例如如果用户的电子邮件收件箱中有两封未读电子邮件并且有一封新电子邮件被推送到用户的设备则的值为一个位数值它是通知的唯一标识符该值可用作发送到控制点特征以与通知进行交互的命令中的句柄根据上边对通知源特征的解析我们可以应用于手环手表显示当前手机的通知信息并且过滤我们需要的通知类别等作用通知的生命周期通过生成的通知源特性通知的格式我们可以隐式推断出通知的生存期如下图从图里可以看出通知的生命周期当我们手机收到通知后会触发如果不主动点开它将一直保留在通知列表中这个时候如果该通知是可以被修改的那么当你修改了该通知后将触发但也有一些是不可修改的那么改事件不一定会被触发但是删除是必定的当你点开通知或者通知刚来你就点开了那么就会触发那么这个通知的生命就到了尽头所以为了爱护通知的生命你可以一直不关它让它存活在你的通知列表里控制点和数据源可能要与通知进行交互它可能希望获取和它有关的更多信息包括其内容或者可能要对其执行操作那么这些属性的检索是通过控制点和数据源特征执行的可以通过将特定命令写入控制点特征来发出检索有关通知的更多信息的请求如果对控制点特征写入成功将通过数据源特征上的通知流得到响应可以通过将特定命令写入控制点特征来对通知执行预定动作有关操作和通知的更多信息请参见执行通知操作获取通知属性使用获取通知属性命令可以检索特定通知的属性获取通知属性命令的格式如图所示获取通知属性命令的格式包含以下信息应设置为位数值代表客户端需要其信息的通知的想要检索的属性列表某些属性后可能需要一个位长度的参数该参数指定希望检索的属性的最大字节数使用了获取那么必然有响应获取通知属性的响应的格式如图所示获取通知属性响应的格式包含以下信息应设置为位数值是以下属性对应的通知的位长度元组的列表属性始终是一个字符串该字符串的长度以字节为单位在元组中提供但不以终止如果通知的请求属性为空或缺失则其长度设置为元组始终与获取通知属性命令的顺序相同获取应用程序属性获取应用程序属性命令允许检索安装在上的特定应用程序的属性获取应用程序属性命令的格式如图所示获取应用程序属性的格式包含以下信息应设置为客户端需要有关其信息的应用程序的字符串标识符该字符串必须以终止想要检索的属性列表同样的使用了获取那么必然有响应获取应用程序属性的响应的格式如图所示其响应的格式则包含以下信息应设置为以下属性对应的应用程序的字符串标识符该字符串以终止位长度元组的列表属性始终是一个字符串该字符串的长度以字节为单位在元组中提供但不以终止如果应用程序的请求属性为空或缺失则其长度设置为元组始终与获取应用程序属性命令的顺序相同注意上面无论是通知属性还是应用程序属性如果响应大于协商的最大传输单位则将其分为多个片段必须通过拼接每个片段来重组响应当收到每个请求属性的完整元组时响应完成上面这两个获取通知属性和应用程序属性有什么作用呢当我们收到通知源特征反馈给我们的信息时我们只能知道它属于那类别的信息但是我们不能知道他们具体的内容是什么但是通过这两个获取接口我们可以获取相应的通知属性拿微信举例我们可以获取其发送的通知的用户名和内容这样我们就可以显示在我们的手环或者手表上执行通知操作执行通知动作命令允许对特定的通知执行预定的动作执行通知操作命令包含以下字段字节数名称描述设定为位数值代表客户端要在其上执行操作的通知的希望对通知执行的所需操作发出此命令时无论成功与否都不会在数据源特征上生成任何数据通知动作从开始可以将与通知关联的潜在操作通知然后可以代表用户请求执行与特定通知关联的操作通过检测由通知源特征生成的通知字段中是否存在设置标志可以向通知有关通知的可执行操作存在一个积极的动作并且与此通知相关联存在一个负面的动作并且与此通知相关联代表执行的实际操作由决定并且取决于它们执行的通知而有所不同例如对来电通知执行肯定动作可能会应答而执行否定动作可能会拒绝既不能假设也不能试图预先猜测在通知上执行的确切操作因为这些操作是基于其无法获得的信息例如实现的版本保证积极和负面的行动与不会令用户感到意外的结果相关联如果存在于通知中则正面和负面的动作可能会以复选标记标记或通常与确认和关闭相关的颜色例如绿色和红色向用户表示可以通过检索中引入的新通知属性来检索简要描述与通知关联的实际操作的标签用于描述可以对通知执行的积极操作的标签用于描述可以对通知执行的负面操作的标签通知操作可以用于我们手表手环来接听或者挂断当前设备的来电其他会话会话在订阅上的通知源特性时开始在取消订阅同一特性或断开与的连接时结束由于不是被设计成一个完整的同步服务因此它不会跟踪各会话的状态因此和之间交换的所有标识符如和和所有数据仅在特定会话中有效当某一特定会话结束时应删除其在该会话期间收集和存储的任何标识符和数据当一个新地会话开始时会尽力告知系统上任何现有的通知可以使用这些信息来构建一个模型用于会话的剩余部分属性获取和缓存强烈建议只在需要时才获取属性或者是为了响应用户的操作例如如果一个选择在一个简单的列表中显示活动的通知并且在用户选择时只显示特定通知的详细信息那么这个通知的属性的检索可以被延迟的触发在会话过程中强烈建议为它遇到的每个应用标识符建立一个的缓存建立这个缓存可以让避免多次检索相同地不可改变的属性从而节省时间并保护电池错误代码写入控制点特性时可能会收到以下特定于的错误代码未知命令无法识别无效的命令该命令的格式不正确无效的参数参数之一例如未引用上的现有对象操作失败未执行操作如果响应错误它将不会在数据源特性上为相应命令生成任何通知示例这是规范上的示例拿来分析下当设备连接配对了手机之后设备发现服务和特征我们需要订阅通知源并且可以根据自己的需求来选择是否需要控制点和通知源当手机上有新的通知时会通过通知源通知我们的设备同样的当设备连接配对了手机之后设备发现服务和特征并且订阅了相应的特征值当手机接收到来电时会发送该通知的图上标识了和其他信息如消息类别等图上未标识给设备我们可以根据自己的需要当需要获取通知的具体内容时我们可以通过获取通知属性的指令来获取相应通知的内容图上获取属性为手机收到后同样地会返回相应的通知属性给设备我们可以根据反馈的内容对这些内容进行处理例如显示等结语关于蓝牙的的总结就分享到这里了如果在文中发现有误欢迎指出我会及时修改的提前感谢规范其实已经总结的很清楚了有兴趣的小伙伴也可以看看',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2022-04-08 22:47:41',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/other/avatar_240x240.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">nixgnauhcuy</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)" rel="external nofollow noreferrer">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AMS/" style="font-size: 1.05rem;">AMS<sup>1</sup></a><a href="/tags/ANCS/" style="font-size: 1.05rem;">ANCS<sup>1</sup></a><a href="/tags/BLE/" style="font-size: 1.05rem;">BLE<sup>3</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C<sup>3</sup></a><a href="/tags/ESP32/" style="font-size: 1.05rem;">ESP32<sup>3</sup></a><a href="/tags/GPT/" style="font-size: 1.05rem;">GPT<sup>3</sup></a><a href="/tags/IOS/" style="font-size: 1.05rem;">IOS<sup>2</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>1</sup></a><a href="/tags/Nand-Flash/" style="font-size: 1.05rem;">Nand Flash<sup>1</sup></a><a href="/tags/Nor-Flash/" style="font-size: 1.05rem;">Nor Flash<sup>1</sup></a><a href="/tags/keil/" style="font-size: 1.05rem;">keil<sup>3</sup></a><a href="/tags/python/" style="font-size: 1.05rem;">python<sup>7</sup></a><a href="/tags/%E4%B8%B2%E5%8F%A3/" style="font-size: 1.05rem;">串口<sup>2</sup></a><a href="/tags/%E4%BD%8D%E5%9F%9F/" style="font-size: 1.05rem;">位域<sup>1</sup></a><a href="/tags/%E4%BD%8D%E5%AD%97%E6%AE%B5/" style="font-size: 1.05rem;">位字段<sup>1</sup></a><a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/" style="font-size: 1.05rem;">嵌入式<sup>23</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">工具<sup>5</sup></a><a href="/tags/%E6%8A%80%E5%B7%A7/" style="font-size: 1.05rem;">技巧<sup>2</sup></a><a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 1.05rem;">生活<sup>1</sup></a><a href="/tags/%E8%8B%B1%E6%96%87/" style="font-size: 1.05rem;">英文<sup>1</sup></a><a href="/tags/%E8%93%9D%E7%89%99/" style="font-size: 1.05rem;">蓝牙<sup>4</sup></a><a href="/tags/%E8%B8%A9%E5%9D%91/" style="font-size: 1.05rem;">踩坑<sup>2</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 1.05rem;">软件<sup>4</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">十二月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/03/"><span class="card-archive-list-date">三月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/12/"><span class="card-archive-list-date">十二月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/04/"><span class="card-archive-list-date">四月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);" rel="external nofollow noreferrer"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%93%9D%E7%89%99/" itemprop="url">蓝牙</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/BLE/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>BLE</span></a><a class="article-meta__tags" href="/tags/%E8%93%9D%E7%89%99/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>蓝牙</span></a><a class="article-meta__tags" href="/tags/IOS/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>IOS</span></a><a class="article-meta__tags" href="/tags/ANCS/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>ANCS</span></a></span></div></div><h1 class="post-title" itemprop="name headline">蓝牙开发之 IOS ANCS</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2021-03-15T14:47:41.000Z" title="发表于 2021-03-15 22:47:41">2021-03-15</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2022-04-08T14:47:41.000Z" title="更新于 2022-04-08 22:47:41">2022-04-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">4.7k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>15分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为深圳"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>深圳</span></div></div></div><article class="post-content" id="article-container" itemscope itemtype="https://www.nixgnauhcuy.cn/f0b6078aa8de/"><header><a class="post-meta-categories" href="/categories/%E8%93%9D%E7%89%99/" itemprop="url">蓝牙</a><a href="/tags/BLE/" tabindex="-1" itemprop="url">BLE</a><a href="/tags/%E8%93%9D%E7%89%99/" tabindex="-1" itemprop="url">蓝牙</a><a href="/tags/IOS/" tabindex="-1" itemprop="url">IOS</a><a href="/tags/ANCS/" tabindex="-1" itemprop="url">ANCS</a><h1 id="CrawlerTitle" itemprop="name headline">蓝牙开发之 IOS ANCS</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">nixgnauhcuy</span><time itemprop="dateCreated datePublished" datetime="2021-03-15T14:47:41.000Z" title="发表于 2021-03-15 22:47:41">2021-03-15</time><time itemprop="dateCreated datePublished" datetime="2022-04-08T14:47:41.000Z" title="更新于 2022-04-08 22:47:41">2022-04-08</time></header><blockquote>
<p><strong>2022-04-12：更新 <a href="https://www.nixgnauhcuy.cn/e7b57229acd4/">蓝牙开发之 IOS AMS</a>，有兴趣的可以点击链接进入~</strong></p>
<p><strong>2022-04-08：更新接收推送效果</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/ancs.gif" alt="效果"></p>
<p><strong>上图演示了，接收微信通知和 QQ 通知的展示，短信来电等我就不一一展示了。</strong></p>
</blockquote>
<h2 id="什么是-ANCS">什么是 ANCS</h2>
<h3 id="ANCS-介绍-Introduction">ANCS 介绍(Introduction)</h3>
<p><strong>ANCS 全称 Apple Notification Center Service(苹果通知中心服务)，是提供给 BLE 设备的一种获取 IOS 设备通知的方法。ANCS围绕三个原则进行设计：简单，高效和可扩展性。</strong></p>
<blockquote>
<p><strong>以下引用自 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.apple.com/library/archive/documentation/CoreBluetooth/Reference/AppleNotificationCenterServiceSpecification/Introduction/Introduction.html">ANCS 规范</a></strong></p>
<p><strong>The purpose of the Apple Notification Center Service (ANCS) is to give Bluetooth accessories (that connect to iOS devices through a Bluetooth low-energy link) a simple and convenient way to access many kinds of notifications that are generated on iOS devices.</strong></p>
<p><strong>The ANCS is designed around three principles: simplicity, efficiency and scalability. As a result, accessories ranging from simple LEDs to powerful “companion” devices with large displays can find the service useful.</strong></p>
</blockquote>
<hr>
<h3 id="ANCS-字节序和字节码-Endianness-and-String-Encoding">ANCS 字节序和字节码(Endianness and String Encoding)</h3>
<p><strong>除非另有规定，否则通过 ANCS 传输的所有数值都应是小端格式。</strong><br>
<strong>除非另有规定，否则通过 ANCS 传输的所有字符串值都应是 UTF-8 编码的 unicode 字符所组成的。</strong></p>
<hr>
<h3 id="依赖性-Dependencies">依赖性(Dependencies)</h3>
<p><strong>除了标准的通用属性配置文件(GATT)子程序集外，ANCS 没有任何依赖性。作为 GATT 客户端的设备在使用 ANCS 时，可以自由访问和使用 iOS 设备提供的其他服务。</strong></p>
<h3 id="术语-Terminology">术语(Terminology)</h3>
<ol>
<li>
<p><strong>苹果通知中心服务应称为 ANCS。</strong></p>
</li>
<li>
<p><strong>ANCS 服务的发布者(也就是我们的 iOS 设备)应被称为通知提供者(NP)。</strong></p>
</li>
<li>
<p><strong>ANCS 服务的任何客户端(也就是我们的蓝牙设备)应被称为通知消费者(NC)。</strong></p>
</li>
<li>
<p><strong>在 iOS 通知中心显示在 iOS 设备上的通知，应称为 iOS 通知。</strong></p>
</li>
<li>
<p><strong>GATT 特性作为异步消息发送的通知，应称为 GATT 通知。</strong></p>
</li>
</ol>
<hr>
<h2 id="ANCS-理解">ANCS 理解</h2>
<p><strong>上面的对于什么是 ANCS，基本上都是其 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.apple.com/library/archive/documentation/CoreBluetooth/Reference/AppleNotificationCenterServiceSpecification/Introduction/Introduction.html">ANCS 规范</a>中所提及的，不过不能在水文水下去了(<s>在水下去怕读者打我😄</s>)，我们来谈谈对它的理解。</strong></p>
<p><strong>首先 ANCS 最重要的是它的 N 和 S，它告诉了我们，它是一个通知服务，它是基于 GATT 封装的服务，和我们的 nus、hrs 等服务都是一个档次的，只不过它与 IOS 和设备间制定了自己的一套协议，我们要使用它就必须遵守它们之间的规则来办事。</strong></p>
<p><strong>那为什么我们用 nrf connect、LightBlue 等蓝牙工具没办法看到 ANCS 相关的UUID呢？👉这就和 IOS 的机制有关了，IOS 对安全的考虑比安卓要严格的多，IOS 是沙盒机制，限制了每个应用不得翻越自己的围墙去访问别的存储空间的内容，即使能访问也需要授权才可以，所以接触的 IOS 工程师告诉我，他们没办法通过蓝牙去获取其他应用的通知，所以 IOS 提供了这样一个通知服务，但是它是私有的，并不会主动的广播，所以我们用蓝牙工具是看不到这个服务的，并且如果你也是蓝牙的开发者并且你也在折腾 ANCS，那么要清楚，IOS 工程师并不需要在他们的代码中处理 ANCS 相关的代码，我们在蓝牙中做好对 ANCS 的支持和响应，剩下的就是我们蓝牙设备与 IOS 设备的事了。(IOS 开发的工程师们，如果觉得我理解不到位，请轻点喷我，并麻烦指正我的错误😭，感激不尽🙏！)</strong></p>
<blockquote>
<p><strong>ANCS 主服务(Service) UUID 为 7905F431-B5CE-4E99-A40F-4B1E122D00D0</strong></p>
<blockquote>
<p><strong>ANCS 服务下的三个特征(Characteristic) UUID:</strong><br>
<strong>通知源(Notification Source) UUID: 9FBF120D-6301-42D9-8C58-25E699A21DBD(notifiable)</strong><br>
<strong>控制点(Control Point) UUID: 69D1D8F3-45E1-49A8-9821-9BBDFDAAD9D9(writeable with response)</strong><br>
<strong>数据源(Data Source) UUID: 22EAC6E9-24D6-4BB5-BE44-B36ACE7C7BFB(notifiable)</strong></p>
</blockquote>
</blockquote>
<p><strong>上述特征都需要授权才能访问，并且通知源特性是必须要有的，而其他两个控制点和数据源是可选的。ANCS中存在的特征可能比上面列出的三个更多。也就是说，NC 可以忽略任何它不识别的特性。一个 NP 上只能存在一个 ANCS 的实例。由于 iOS 的特性，不能保证 ANCS 始终存在。因此，NC 应寻找并订阅 GATT 服务的 Service Changed 特性，以便随时监控 ANCS 可能的发布和未发布的消息。</strong></p>
<p><strong>这里再扩展一下个人见解，我们实际操作蓝牙服务时都是操作其句柄，这与文件系统类似，打个比方，ANCS 的主服务我们看作文件系统的磁盘，ANCS 的三个特征我们把它看作文件系统的文件例如 a.txt、b.txt、c.txt 三个文件，那么 ANCS 的属性我们把它看作对 a.txt 文件操作时的读和写的属性，是不是极其地相似，我们 open 磁盘后再 open 文件，用获得的句柄对这个文件就有了可读可写的属性，就可以对 txt 文本中写入内容和读出内容。这点是不是和蓝牙服务这一块极其相似。(当然，这只是我个人的观点，方便各位理解，不一定对，如果有误😭，麻烦指正，不胜感激🙏！)</strong></p>
<hr>
<h2 id="ANCS-特征-Characteristic">ANCS 特征(Characteristic)</h2>
<h3 id="通知源-Notification-Source">通知源(Notification Source)</h3>
<p><strong>Notification Source 这个特征值是用于通知我们的蓝牙设备这一消费者(NC)，下面则是得到通知的场景：</strong></p>
<ul>
<li><strong>NP 上有新的 IOS 通知</strong></li>
<li><strong>NP 上修改了 IOS 通知</strong></li>
<li><strong>NP 上删除了 IOS 通知</strong></li>
</ul>
<p><strong>一旦 NC 监控了通知源特征，那么 GATT 通知就可以立即发送。因此，我们在监控这个特征之前，应该处于可以正确接收和处理这些消息的状态。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/00.png" alt="通知源特性传递的 GATT 通知的格式"></p>
<p><strong>通过通知源特征传递的 GATT 通知包含以下信息：</strong></p>
<blockquote>
<ul>
<li><strong>EventID：此字段通知设备是否添加、修改或删除了给定的 iOS 通知。此字段的枚举值在EventID Values中定义。</strong></li>
</ul>
<blockquote>
<p>EventID Values:</p>
<ul>
<li>EventIDNotificationAdded = 0 - iOS 通知已添加</li>
<li>EventIDNotificationModified = 1 - iOS通知已修改</li>
<li>EventIDNotificationRemoved = 2 - iOS通知已删除</li>
</ul>
</blockquote>
<ul>
<li><strong>EventFlags：一个位掩码，其设置位通过 iOS 通知将其特殊性通知给 NC。例如，如果将 iOS 通知视为“重要”，则 NC 可能希望显示一个更积极的用户界面(UI)，以确保正确警告用户。此字段的枚举位在 EventFlags 中定义。</strong></li>
</ul>
<blockquote>
<p>EventFlags：</p>
<ul>
<li>EventFlagSilent = (1 &lt;&lt; 0) - 通知的优先级较低</li>
<li>EventFlagImportant = (1 &lt;&lt; 1) - 通知具有较高的优先级</li>
<li>EventFlagPreExisting = (1 &lt;&lt; 2) - 该通知已存在</li>
<li>EventFlagPositiveAction = (1 &lt;&lt; 3) - 通知具有可以采取的积极行动</li>
<li>EventFlagNegativeAction = (1 &lt;&lt; 4) - 通知具有可以采取的负面行动</li>
</ul>
</blockquote>
<ul>
<li><strong>CategoryID：一个数值，提供对 iOS 通知进行分类的类别。NP 将尽最大努力为每个iOS 通知提供准确的类别。此字段的枚举值在 CategoryID 值中定义。</strong></li>
</ul>
<blockquote>
<p>CategoryID:</p>
<ul>
<li>CategoryIDOther = 0 - iOS 通知属于“其他”类别</li>
<li>CategoryIDIncomingCall = 1 - iOS 通知属于“来电”类别</li>
<li>CategoryIDMissedCall = 2 - iOS 通知属于“未接电话”类别</li>
<li>CategoryIDVoicemail= 3 - iOS 通知属于“语音邮件”类别</li>
<li>CategoryIDSocial = 4 - iOS 通知属于“社交”类别</li>
<li>CategoryIDSchedule = 5 - iOS 通知属于“时间表”类别</li>
<li>CategoryIDEmail = 6 - iOS 通知属于“电子邮件”类别</li>
<li>CategoryIDNews = 7 - iOS 通知属于“新闻”类别</li>
<li>CategoryIDHealthAndFitness = 8 - iOS 通知属于“健康和健身”类别</li>
<li>CategoryIDBusinessAndFinance = 9 - iOS 通知属于“商务和金融”类别</li>
<li>CategoryIDLocation = 10 - iOS 通知属于“位置”类别</li>
<li>CategoryIDEntertainment = 11 - iOS 通知属于“娱乐”类别</li>
</ul>
</blockquote>
<ul>
<li><strong>CategoryCount：给定类别中当前活动的 iOS 通知数。例如，如果用户的电子邮件收件箱中有两封未读电子邮件，并且有一封新电子邮件被推送到用户的 iOS 设备，则 CategoryCount 的值为3。</strong></li>
<li><strong>NotificationUID：一个 32 位数值，它是iOS通知的唯一标识符(UID)。该值可用作发送到“控制点”特征以与 iOS 通知进行交互的命令中的句柄。</strong></li>
</ul>
</blockquote>
<p><strong>根据上边对通知源特征的解析，我们可以应用于手环手表，显示当前手机的通知信息，并且过滤我们需要的通知类别等作用。</strong></p>
<hr>
<h4 id="iOS-通知的生命周期">iOS 通知的生命周期</h4>
<p><strong>通过 NP 生成的通知源特性 GATT 通知的格式，我们可以隐式推断出 iOS 通知的生存期，如下图：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/01.png" alt="iOS 通知的生命周期"></p>
<p><strong>从图里可以看出通知的生命周期，当我们 IOS 手机收到通知后会触发 Notification Added，如果不主动点开，它将一直保留在通知列表中，这个时候如果该通知是可以被修改的，那么当你修改了该通知后，将触发 Notification Modified，但也有一些是不可修改的，那么改事件不一定会被触发，但是删除是必定的，当你点开通知或者通知刚来你就点开了，那么就会触发 Notification Removed，那么这个通知的生命就到了尽头。<s>所以为了爱护通知的生命，你可以一直不关它，让它存活在你的通知列表里，hhhh😄。</s></strong></p>
<hr>
<h3 id="控制点-Control-Point-和数据源-Data-Source">控制点(Control Point)和数据源(Data Source)</h3>
<p><strong>NC 可能要与 iOS 通知进行交互。它可能希望获取和它有关的更多信息，包括其内容，或者可能要对其执行操作。那么这些属性的检索是通过控制点和数据源特征执行的。</strong></p>
<p><strong>NC 可以通过将特定命令写入控制点特征来发出检索有关 iOS 通知的更多信息的请求。如果对控制点特征写入成功，NP 将通过数据源特征上的 GATT 通知流得到响应。</strong></p>
<p><strong>NC 可以通过将特定命令写入控制点特征来对 iOS 通知执行预定动作。有关操作和 iOS 通知的更多信息，请参见“<a href="#%E6%89%A7%E8%A1%8C%E9%80%9A%E7%9F%A5%E6%93%8D%E4%BD%9C">执行通知操作</a>”。</strong></p>
<hr>
<h4 id="获取通知属性">获取通知属性</h4>
<p><strong>使用“获取通知属性”命令，NC 可以检索特定 iOS 通知的属性。“获取通知属性”命令的格式如图所示。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/02.png" alt="“获取通知属性”命令的格式"></p>
<p><strong>获取通知属性命令的格式包含以下信息：</strong></p>
<blockquote>
<ul>
<li><strong>CommandID：应设置为 0(CommandIDGetAppAttributes)。</strong></li>
<li><strong>NotificationUID： 32 位数值，代表客户端需要其信息的 iOS 通知的 UID。</strong></li>
<li><strong>AttributeIDs： NC 想要检索的属性列表。某些属性后可能需要一个 16 位长度的参数，该参数指定 NC 希望检索的属性的最大字节数。</strong></li>
</ul>
</blockquote>
<p><strong>使用了获取，那么必然有响应，“获取通知属性”的响应的格式如图所示。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/03.png" alt="“获取通知属性”响应"></p>
<p><strong>获取通知属性响应的格式包含以下信息：</strong></p>
<blockquote>
<ul>
<li><strong>CommandID：应设置为 0(CommandIDGetAppAttributes)。</strong></li>
<li><strong>NotificationUID： 32 位数值，是以下属性对应的 iOS 通知的 UID。</strong></li>
<li><strong>AttributeList： AttributeID / 16 位长度 / Attribute 元组的列表。属性始终是一个字符串，该字符串的长度(以字节为单位)在元组中提供，但不以 NULL 终止。如果 iOS 通知的请求属性为空或缺失，则其长度设置为 0。元组始终与“获取通知属性”命令的 AttributeID 顺序相同。。</strong></li>
</ul>
</blockquote>
<hr>
<h4 id="获取应用程序属性">获取应用程序属性</h4>
<p><strong>“获取应用程序属性”命令允许 NC 检索安装在 NP 上的特定应用程序的属性。“获取应用程序属性”命令的格式如图所示。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/04.png" alt="获取应用程序属性"></p>
<p><strong>获取应用程序属性的格式包含以下信息：</strong></p>
<blockquote>
<ul>
<li><strong>CommandID：应设置为1(CommandIDGetAppAttributes)。</strong></li>
<li><strong>AppIdentifier：客户端需要有关其信息的应用程序的字符串标识符。该字符串必须以 NULL 终止。</strong></li>
<li><strong>AttributeIDs： NC 想要检索的属性列表。</strong></li>
</ul>
</blockquote>
<p><strong>同样的，使用了获取，那么必然有响应，“获取应用程序属性”的响应的格式如图所示。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/05.png" alt="获取应用程序属性响应"></p>
<p><strong>其响应的格式则包含以下信息：</strong></p>
<blockquote>
<ul>
<li><strong>CommandID：应设置为1(CommandIDGetAppAttributes)。</strong></li>
<li><strong>AppIdentifier：以下属性对应的应用程序的字符串标识符。该字符串以 NULL 终止。</strong></li>
<li><strong>AttributeList： AttributeID / 16 位长度 / Attribute 元组的列表。属性始终是一个字符串，该字符串的长度(以字节为单位)在元组中提供，但不以 NULL 终止。如果应用程序的请求属性为空或缺失，则其长度设置为 0。元组始终与“获取应用程序属性”命令的 AttributeID 顺序相同。</strong></li>
</ul>
</blockquote>
<blockquote>
<p><strong>👉注意：上面无论是通知属性还是应用程序属性如果响应大于协商的 GATT 最大传输单位（MTU），则 NP 将其分为多个片段。NC 必须通过拼接每个片段来重组响应。当收到每个请求属性的完整元组时，响应完成。</strong></p>
</blockquote>
<p><strong>上面这两个获取通知属性和应用程序属性有什么作用呢？当我们收到通知源特征反馈给我们的信息时，我们只能知道它属于那类别的信息，但是我们不能知道他们具体的内容是什么，但是通过这两个获取接口，我们可以获取相应的通知属性，拿微信💬举例，我们可以获取其发送的通知的用户名和内容，这样我们就可以显示在我们的手环或者手表上。</strong></p>
<hr>
<h3 id="执行通知操作">执行通知操作</h3>
<p><strong>执行通知动作命令允许 NC 对特定的 iOS 通知执行预定的动作。执行通知操作命令包含以下字段：</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">字节数</th>
<th style="text-align:center">名称</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">CommandID</td>
<td style="text-align:center">设定为2(CommandIDPerformNotificationAction)</td>
</tr>
<tr>
<td style="text-align:center">2-5</td>
<td style="text-align:center">NotificationUID</td>
<td style="text-align:center">32位数值，代表客户端要在其上执行操作的 iOS 通知的 UID。</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">ActionID</td>
<td style="text-align:center">NC 希望对 iOS 通知执行的所需操作。</td>
</tr>
</tbody>
</table>
<p><strong>发出此命令时，无论成功与否，都不会在数据源特征上生成任何数据。</strong></p>
<h4 id="通知动作">通知动作</h4>
<p><strong>从 iOS 8.0 开始，NP 可以将与 iOS 通知关联的潜在操作通知 NC。然后，NC 可以代表用户请求 NP 执行与特定 iOS 通知关联的操作。</strong><br>
<strong>通过检测 EventFlags 由通知源特征生成的 GATT 通知字段中是否存在设置标志，可以向 NC 通知有关 iOS 通知的可执行操作：</strong></p>
<blockquote>
<ul>
<li><strong>EventFlagPositiveAction: 存在一个积极的动作，并且与此 iOS 通知相关联。</strong></li>
<li><strong>EventFlagNegativeAction: 存在一个负面的动作，并且与此 iOS 通知相关联。</strong></li>
</ul>
</blockquote>
<p><strong>NP 代表 NC 执行的实际操作由 NP 决定，并且取决于它们执行的 iOS 通知而有所不同。例如，对来电通知执行肯定动作可能会应答，而执行否定动作可能会拒绝。</strong></p>
<p><strong>NC 既不能假设也不能试图预先猜测在 iOS 通知上执行的确切操作，因为这些操作是基于其无法获得的信息(例如，NP 实现的 ANCS 版本)。NP 保证积极和负面的行动与不会令用户感到意外的结果相关联。</strong></p>
<p><strong>如果存在于 iOS 通知中，则正面和负面的动作可能会以复选标记，X 标记或通常与确认和关闭相关的颜色（例如绿色和红色）向用户表示。</strong></p>
<p><strong>NC可以通过检索 iOS 8.0 中引入的新通知属性来检索简要描述与 iOS 通知关联的实际操作的标签：</strong></p>
<blockquote>
<ul>
<li><strong>NotificationAttributeIDPositiveActionLabel：用于描述可以对 iOS 通知执行的积极操作的标签。</strong></li>
<li><strong>NotificationAttributeIDNegativeActionLabel：用于描述可以对 iOS 通知执行的负面操作的标签。</strong></li>
</ul>
</blockquote>
<p><strong>通知操作，可以用于我们手表手环来接听或者挂断当前 IOS 设备的来电📱。</strong></p>
<hr>
<h2 id="其他">其他</h2>
<h3 id="会话-Session">会话(Session)</h3>
<p><strong>ANCS 会话在 NC 订阅 NP 上的通知源特性时开始，在 NC 取消订阅同一特性或断开与 NP 的连接时结束。由于 ANCS 不是被设计成一个完整的同步服务，因此它不会跟踪各会话的状态。因此，NC 和 NP 之间交换的所有标识符（如 NotificationUID 和 AppIdentifier）和所有数据仅在特定会话中有效。</strong></p>
<p><strong>当某一特定会话结束时，NC 应删除其在该会话期间收集和存储的任何标识符和数据。当一个新地会话开始时，NP 会尽力告知 NC 系统上任何现有的 iOS 通知。NC 可以使用这些信息来构建一个模型，用于会话的剩余部分。</strong></p>
<hr>
<h3 id="属性获取和缓存-Attribute-Fetching-and-Caching">属性获取和缓存(Attribute Fetching and Caching)</h3>
<p><strong>强烈建议 NC 只在需要时才获取属性，或者是为了响应用户的操作。例如，如果一个 NC 选择在一个简单的列表中显示活动的 iOS 通知，并且在用户选择时只显示特定 iOS 通知的详细信息，那么这个 iOS 通知的属性的检索可以被延迟的触发。</strong></p>
<p><strong>在会话过程中，强烈建议 NC 为它遇到的每个应用标识符建立一个 App Attributes 的缓存。建立这个缓存可以让 NC 避免多次检索相同地不可改变的 App 属性，从而节省时间并保护电池。</strong></p>
<hr>
<h3 id="错误代码-Error-Codes">错误代码(Error Codes)</h3>
<p><strong>写入控制点特性时，NC 可能会收到以下特定于 ANCS 的错误代码：</strong></p>
<blockquote>
<ul>
<li><strong>未知命令 (0xA0): NP 无法识别 commandID。</strong></li>
<li><strong>无效的命令 (0xA1): 该命令的格式不正确。</strong></li>
<li><strong>无效的参数 (0xA2): 参数之一（例如 NotificationUID）未引用 NP 上的现有对象。</strong></li>
<li><strong>操作失败 (0xA3): 未执行操作。</strong></li>
</ul>
</blockquote>
<p><strong>如果 NP 响应错误，它将不会在数据源特性上为相应命令生成任何 GATT 通知。</strong></p>
<hr>
<h2 id="示例">示例</h2>
<p><strong>这是 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.apple.com/library/archive/documentation/CoreBluetooth/Reference/AppleNotificationCenterServiceSpecification/Introduction/Introduction.html">ANCS 规范</a>上的示例，拿来分析下。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/06.png" alt="服务设置示例"></p>
<p><strong>当设备(NC)连接配对了手机(NP)之后，设备发现 ANCS 服务和特征，我们需要订阅通知源并且可以根据自己的需求来选择是否需要控制点和通知源。当手机上有新的通知时，会通过通知源通知我们的设备。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210315/07.png" alt="通知属性检索示例"></p>
<p><strong>同样的当设备(NC)连接配对了手机(NP)之后，设备发现 ANCS 服务和特征并且订阅了相应的特征值。当手机接收到来电时，会发送该通知的 UID(图上标识了)和其他信息(如，消息类别等，图上未标识)给设备。我们可以根据自己的需要，当需要获取通知的具体内容时，我们可以通过获取通知属性的指令来获取相应通知的内容。图上获取属性为 Title、Message、AppID，手机收到后，同样地会返回相应的通知属性给设备。我们可以根据反馈的内容，对这些内容进行处理(例如显示等)。</strong></p>
<hr>
<h2 id="结语">结语</h2>
<p><strong>关于蓝牙的 IOS ANCS 的总结就分享到这里了，如果在文中发现有误，欢迎指出，我会及时修改的，提前感谢🙏！<a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.apple.com/library/archive/documentation/CoreBluetooth/Reference/AppleNotificationCenterServiceSpecification/Introduction/Introduction.html">ANCS 规范</a>其实已经总结的很清楚了，有兴趣的小伙伴也可以看看！</strong></p>
<hr>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/other/avatar_240x240.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/other/avatar_240x240.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">nixgnauhcuy</div><div class="post-copyright__author_desc">Life-long learning</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.nixgnauhcuy.cn/f0b6078aa8de/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://www.nixgnauhcuy.cn/f0b6078aa8de/')">蓝牙开发之 IOS ANCS</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.nixgnauhcuy.cn/f0b6078aa8de/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=undefined&amp;url=https://www.nixgnauhcuy.cn/f0b6078aa8de/&amp;pic=undefined" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.nixgnauhcuy.cn" target="_blank">nixgnauhcuy</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/BLE/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>BLE<span class="tagsPageCount">3</span></a><a class="post-meta__box__tags" href="/tags/%E8%93%9D%E7%89%99/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>蓝牙<span class="tagsPageCount">4</span></a><a class="post-meta__box__tags" href="/tags/IOS/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>IOS<span class="tagsPageCount">2</span></a><a class="post-meta__box__tags" href="/tags/ANCS/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>ANCS<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20231201/cover.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/280ff73bac80/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210312/conver.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">RTOS 使用看门狗策略</div></div></a></div><div class="next-post pull-right"><a href="/72de75b96592/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20210406/image.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">C语言位域</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/e7b57229acd4/" title="蓝牙开发之 IOS AMS"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20220412/image.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-04-12</div><div class="title">蓝牙开发之 IOS AMS</div></div></a></div><div><a href="/91206d67d16b/" title="蓝牙多点测距小记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/markdown/20240328/cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-28</div><div class="title">蓝牙多点测距小记</div></div></a></div><div><a href="/721a3f9ff3ad/" title="nrf52840 内部 flash 结构"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/default_cover/04.jpg?_r_=f775addb-0b78-0359-c174-5c1da19446be" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2020-12-27</div><div class="title">nrf52840 内部 flash 结构</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/other/avatar_240x240.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">分享一些<b style="color:#fff">学习经验</b>以及一些<b style="color:#fff">杂七杂八的内容</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about/"><h1 class="author-info__name">nixgnauhcuy</h1><div class="author-info__desc">Life-long learning</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/nixgnauhcuy" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">佛系更新博客~</div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://testingcf.jsdelivr.net/gh/nixgnauhcuy/blog_cdn/img/other/wechat.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-ANCS"><span class="toc-number">1.</span> <span class="toc-text">什么是 ANCS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ANCS-%E4%BB%8B%E7%BB%8D-Introduction"><span class="toc-number">1.1.</span> <span class="toc-text">ANCS 介绍(Introduction)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ANCS-%E5%AD%97%E8%8A%82%E5%BA%8F%E5%92%8C%E5%AD%97%E8%8A%82%E7%A0%81-Endianness-and-String-Encoding"><span class="toc-number">1.2.</span> <span class="toc-text">ANCS 字节序和字节码(Endianness and String Encoding)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E6%80%A7-Dependencies"><span class="toc-number">1.3.</span> <span class="toc-text">依赖性(Dependencies)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AF%E8%AF%AD-Terminology"><span class="toc-number">1.4.</span> <span class="toc-text">术语(Terminology)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ANCS-%E7%90%86%E8%A7%A3"><span class="toc-number">2.</span> <span class="toc-text">ANCS 理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ANCS-%E7%89%B9%E5%BE%81-Characteristic"><span class="toc-number">3.</span> <span class="toc-text">ANCS 特征(Characteristic)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E6%BA%90-Notification-Source"><span class="toc-number">3.1.</span> <span class="toc-text">通知源(Notification Source)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#iOS-%E9%80%9A%E7%9F%A5%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">3.1.1.</span> <span class="toc-text">iOS 通知的生命周期</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E7%82%B9-Control-Point-%E5%92%8C%E6%95%B0%E6%8D%AE%E6%BA%90-Data-Source"><span class="toc-number">3.2.</span> <span class="toc-text">控制点(Control Point)和数据源(Data Source)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E9%80%9A%E7%9F%A5%E5%B1%9E%E6%80%A7"><span class="toc-number">3.2.1.</span> <span class="toc-text">获取通知属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%B1%9E%E6%80%A7"><span class="toc-number">3.2.2.</span> <span class="toc-text">获取应用程序属性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E9%80%9A%E7%9F%A5%E6%93%8D%E4%BD%9C"><span class="toc-number">3.3.</span> <span class="toc-text">执行通知操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E5%8A%A8%E4%BD%9C"><span class="toc-number">3.3.1.</span> <span class="toc-text">通知动作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">4.</span> <span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D-Session"><span class="toc-number">4.1.</span> <span class="toc-text">会话(Session)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E8%8E%B7%E5%8F%96%E5%92%8C%E7%BC%93%E5%AD%98-Attribute-Fetching-and-Caching"><span class="toc-number">4.2.</span> <span class="toc-text">属性获取和缓存(Attribute Fetching and Caching)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E4%BB%A3%E7%A0%81-Error-Codes"><span class="toc-number">4.3.</span> <span class="toc-text">错误代码(Error Codes)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-number">6.</span> <span class="toc-text">结语</span></a></li></ol></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By nixgnauhcuy</div><div id="workboard"><div id="runtimeTextTip"></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">40</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">12</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" rel="external nofollow noreferrer" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("11/28/2020 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-下班啦.svg";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = async () => {
    try {
      const res = await fetch('https://waline-two.vercel.app/api/comment?type=recent&count=6', { method: 'GET' })
      const result = await res.json()
      const walineArray = result.data.map(e => {
        return {
          'content': changeContent(e.comment),
          'avatar': e.avatar,
          'nick': e.nick,
          'url': e.url + '#' + e.objectId,
          'date': e.time || e.insertedAt
        }
      })
      saveToLocal.set('waline-newest-comments', JSON.stringify(walineArray), 10/(60*24))
      generateHtml(walineArray)
    } catch (err) {
      console.error(err)
      const $dom = document.querySelector('#card-newest-comments .aside-list')
      $dom.textContent= "无法获取评论，请确认相关配置是否正确"
    }
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('waline-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-2VWCFFF041', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>